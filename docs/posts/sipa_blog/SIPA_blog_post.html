<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.543">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Rachel Baccile">
<meta name="dcterms.date" content="2024-02-07">

<title>CLIF - Constructing an Analytic Dataset from CLIF</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">CLIF</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">TEAM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Constructing an Analytic Dataset from CLIF</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">longitudinal-dataset</div>
                <div class="quarto-category">analysis</div>
                <div class="quarto-category">SIPA</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Rachel Baccile </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 7, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#cohort-identification" id="toc-cohort-identification" class="nav-link active" data-scroll-target="#cohort-identification">1. Cohort Identification</a>
  <ul class="collapse">
  <li><a href="#identify-adults-during-time-period-that-were-admitted-to-the-hospital" id="toc-identify-adults-during-time-period-that-were-admitted-to-the-hospital" class="nav-link" data-scroll-target="#identify-adults-during-time-period-that-were-admitted-to-the-hospital">1.1 Identify Adults during time period that were admitted to the hospital</a></li>
  <li><a href="#determine-if-patients-meet-respiratory-criteria" id="toc-determine-if-patients-meet-respiratory-criteria" class="nav-link" data-scroll-target="#determine-if-patients-meet-respiratory-criteria">1.2 Determine if patients meet respiratory criteria</a></li>
  <li><a href="#determine-if-patients-received-vasopressors" id="toc-determine-if-patients-received-vasopressors" class="nav-link" data-scroll-target="#determine-if-patients-received-vasopressors">1.3 Determine if patients received vasopressors</a></li>
  <li><a href="#determine-start-of-life-support" id="toc-determine-start-of-life-support" class="nav-link" data-scroll-target="#determine-start-of-life-support">1.4 Determine start of life support</a></li>
  </ul></li>
  <li><a href="#constructing-a-48-hour-analytic-dataset" id="toc-constructing-a-48-hour-analytic-dataset" class="nav-link" data-scroll-target="#constructing-a-48-hour-analytic-dataset">2. Constructing a 48 Hour Analytic Dataset</a>
  <ul class="collapse">
  <li><a href="#hour-labs" id="toc-hour-labs" class="nav-link" data-scroll-target="#hour-labs">2.1 48 Hour Labs</a></li>
  <li><a href="#hour-vitals" id="toc-hour-vitals" class="nav-link" data-scroll-target="#hour-vitals">2.2 48 Hour Vitals</a></li>
  <li><a href="#combining-respiratory-support-vitals-and-medication-to-determine-hours-of-life-support-received" id="toc-combining-respiratory-support-vitals-and-medication-to-determine-hours-of-life-support-received" class="nav-link" data-scroll-target="#combining-respiratory-support-vitals-and-medication-to-determine-hours-of-life-support-received">2.3 Combining respiratory support, vitals, and medication to determine hours of life support received</a></li>
  <li><a href="#merging-scores-labs-and-dialysis-flag" id="toc-merging-scores-labs-and-dialysis-flag" class="nav-link" data-scroll-target="#merging-scores-labs-and-dialysis-flag">2.4 Merging scores, labs, and dialysis flag</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="cohort-identification" class="level2">
<h2 class="anchored" data-anchor-id="cohort-identification">1. Cohort Identification</h2>
<p><strong>Cohort Definition</strong>: Data from UCMC COVID Datamart. Adult patients (18+) admitted January 1 2020 – March 31, 2022 and who recieved life support. Life support was defined as:</p>
<ul>
<li>Received vasoactive medications for shock, <strong>or</strong></li>
<li>Received invasive or non-invasive mechanical ventilation, <strong>or</strong></li>
<li>Received oxygen therapy with PaO2/FiO2 &lt; 200 (S/F &lt; 179 if no P/F measured)</li>
</ul>
<p>Patients were excluded in they were discharged from the ED (including to hospice) and if they received &lt; 6 hours of life support.</p>
<p><strong>CLIF tables used</strong>:</p>
<ul>
<li>RCLIF_limited_identifers (admission date, discharge date)</li>
<li>RCLIF_encounter_demographics_dispo (age at admission, disposition)</li>
<li>RCLIF_adt (location in hospital)</li>
<li>RCLIF_resp_support (respiratory support device, FiO2)</li>
<li>RCLIF_labs (PaO2)</li>
<li>RCLIF_vitals (SpO2)</li>
<li>RCLIF_medication_adm_continuous (vasopressors)</li>
</ul>
<section id="identify-adults-during-time-period-that-were-admitted-to-the-hospital" class="level3">
<h3 class="anchored" data-anchor-id="identify-adults-during-time-period-that-were-admitted-to-the-hospital">1.1 Identify Adults during time period that were admitted to the hospital</h3>
<ol type="1">
<li>Use RCLIF_limited_identifers to identify admissions in the time period of interest (variable: admission_dttm)</li>
<li>Use RCLIF_encounter_demographics_dispo to filter for only those 18+ at time of admission (variable: age_at_admission)</li>
<li>Use the ADT table to filter out those only seen in the ER (variable: dept_name)</li>
<li>“Explode” the data between admission_dttm and discharge_dttm to get hourly blocks for the duration of admission</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">######## Load in limited IDs for admission dates in time period</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">"/project2/wparker/SIPA_data/RCLIF_limited_identifers.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.withColumn(<span class="st">'admission_datetime'</span>,f.to_timestamp(<span class="st">'admission_date'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.withColumn(<span class="st">'discharge_datetime'</span>,f.to_timestamp(<span class="st">'discharge_date'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'admission_datetime'</span>, <span class="st">'discharge_datetime'</span>, <span class="st">'zip_code'</span>).distinct()</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to time period</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.<span class="bu">filter</span>(((f.col(<span class="st">'admission_datetime'</span>)<span class="op">&gt;=</span><span class="st">'2020-03-01'</span>) <span class="op">&amp;</span> </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                   (f.col(<span class="st">'admission_datetime'</span>)<span class="op">&lt;=</span><span class="st">'2022-03-31'</span>)))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.<span class="bu">filter</span>((f.col(<span class="st">'discharge_datetime'</span>)<span class="op">&gt;=</span>f.col(<span class="st">'admission_datetime'</span>)))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.<span class="bu">filter</span>(f.col(<span class="st">'discharge_datetime'</span>).isNotNull())</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>limited_ids <span class="op">=</span> limited_ids.<span class="bu">filter</span>(f.col(<span class="st">'admission_datetime'</span>).isNotNull())</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">######## Load in encounters for age and discharge disposition</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>demo_disp <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">"/project2/wparker/SIPA_data/RCLIF_encounter_demographics_dispo.csv"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>demo_disp <span class="op">=</span> demo_disp.withColumn(<span class="st">"age_at_admission"</span>,demo_disp.age_at_admission.cast(<span class="st">'double'</span>))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>demo_disp <span class="op">=</span> demo_disp.select(<span class="st">'C19_PATIENT_ID'</span>, <span class="st">'C19_HAR_ID'</span>, <span class="st">'age_at_admission'</span>, <span class="st">'disposition'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to adults only</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>demo_disp <span class="op">=</span> demo_disp.<span class="bu">filter</span>(f.col(<span class="st">'age_at_admission'</span>)<span class="op">&gt;=</span><span class="dv">18</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>adults_in_time <span class="op">=</span> limited_ids.join(demo_disp, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Exclude people only in ER</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>adt <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">"/project2/wparker/SIPA_data/RCLIF_adt.csv"</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>adult_ids <span class="op">=</span> adults_in_time.select(<span class="st">'C19_HAR_ID'</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>adt_adults <span class="op">=</span> adult_ids.join(adt, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>adt_adults <span class="op">=</span> adt_adults.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'dept_name'</span>).distinct()</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>adt_adults <span class="op">=</span> adt_adults.withColumn(<span class="st">'count'</span>, f.lit(<span class="dv">1</span>))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>adt_adults_wide <span class="op">=</span> adt_adults.groupBy(<span class="st">'C19_HAR_ID'</span>).pivot(<span class="st">'dept_name'</span>).agg(f.<span class="bu">sum</span>(<span class="st">'count'</span>))</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>adt_adults_wide <span class="op">=</span> adt_adults_wide.<span class="bu">filter</span>(f.col(<span class="st">'ICU'</span>).isNotNull() <span class="op">|</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>                                         f.col(<span class="st">'NA'</span>).isNotNull() <span class="op">|</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                                         f.col(<span class="st">'OR'</span>).isNotNull() <span class="op">|</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                                         f.col(<span class="st">'Ward'</span>).isNotNull())</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>adt_adults_wide <span class="op">=</span> adt_adults_wide.select(<span class="st">'C19_HAR_ID'</span>).distinct()</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>adults_in_time <span class="op">=</span> adt_adults_wide.join(adults_in_time, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>har_ids <span class="op">=</span> adults_in_time.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'admission_datetime'</span>, <span class="st">'discharge_datetime'</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">## Explode between admission and discharge to get all hourly timestamps</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>har_ids_hours <span class="op">=</span> har_ids.withColumn(<span class="st">'txnDt'</span>, f.explode(f.expr(<span class="st">'sequence(admission_datetime, discharge_datetime, interval 1 hour)'</span>)))</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>har_ids_hours <span class="op">=</span> har_ids_hours.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'txnDt'</span>)))</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>har_ids_hours <span class="op">=</span> har_ids_hours.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'txnDt'</span>)))</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>har_ids_hours <span class="op">=</span> har_ids_hours.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'txnDt'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>).orderBy(<span class="st">'C19_HAR_ID'</span>, <span class="st">'txnDt'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="determine-if-patients-meet-respiratory-criteria" class="level3">
<h3 class="anchored" data-anchor-id="determine-if-patients-meet-respiratory-criteria">1.2 Determine if patients meet respiratory criteria</h3>
<p>Use RCLIF_resp_support table to identify instances of invasive or non-invasive mechanical ventilation. If no invasive or non-invasive mechanical ventilation, use RCLIF_resp_support, RCLIF_labs, and RCLIF_vitals to calculate PaO2/FiO2 or Sp02.</p>
<section id="prepare-rclif_resp_support" class="level4">
<h4 class="anchored" data-anchor-id="prepare-rclif_resp_support">1.2.1 Prepare RCLIF_resp_support</h4>
<ol type="1">
<li>Inner join RCLIF_resp_support to adults hospitalized in time period, identified in previous code block.</li>
<li>Filter out invalid FiO2 measurements
<ul>
<li>N removed: 3,440 observations; 376 unique encounters</li>
</ul></li>
<li>Remove instances of CPAP
<ul>
<li>CPAP defined as device_name == “NIPPV” and without an FiO2 measurement, or when mode_name == “CPAP”</li>
<li>N removed: 357,851 observations; 128 unique encounters</li>
</ul></li>
<li>If device_name was missing, fill in based on the following logic:
<ul>
<li>If fio2 ==.21 and lpm, peep, and set_volume are null, then device_name == Room Air</li>
<li>If fio2 ==.21, lpm==0, and peep and set_volume are null, then device_name == Room Air</li>
<li>If fio2, peep, and set_volume are null and lpm &lt;=20 then device_name == Nasal Cannula</li>
<li>If fio2, peep, and set_volume are null and lpm &gt;20 then device_name == High Flow NC</li>
<li>If fio2 and lpm are null and set_volumne is not null, then device_name == Vent</li>
</ul></li>
<li>If device_name was Nasal Cannula but lpm &gt; 20, then device_name== High Flow NC</li>
<li>If fio2 is missing and device_name == Room Air, then fio2== 0.21</li>
<li>If fio2 is missing and device_name == Nasal Cannula, then fio2 was calculated as: ( 0.24 + (0.04 * lpm) )</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">######### Get worst FiO2</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">## Read in respiratory support table</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">'/project2/wparker/SIPA_data/RCLIF_resp_support.csv'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">'recorded_time'</span>,f.to_timestamp(<span class="st">'recorded_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">"fio2"</span>,resp_full.fio2.cast(<span class="st">'double'</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">"lpm"</span>,resp_full.lpm.cast(<span class="st">'double'</span>))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">"peep"</span>,resp_full.peep.cast(<span class="st">'double'</span>))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">"set_volume"</span>,resp_full.peep.cast(<span class="st">'double'</span>))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">## Filter to only adults in time frame</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> har_ids.join(resp_full, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">##Filter to only variables we need</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.select(<span class="st">'C19_PATIENT_ID'</span>, <span class="st">'C19_HAR_ID'</span>, <span class="st">'recorded_time'</span>, <span class="st">'device_name'</span>, <span class="st">'mode_name'</span>, <span class="st">'mode_category'</span>,<span class="st">'lpm'</span>, <span class="st">'fio2'</span>, <span class="st">'peep'</span>, <span class="st">'set_volume'</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">## Filter for valid values or Null</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.<span class="bu">filter</span>((((f.col(<span class="st">'fio2'</span>)<span class="op">&gt;=</span><span class="fl">0.21</span>) <span class="op">&amp;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'fio2'</span>)<span class="op">&lt;=</span><span class="dv">1</span>)) <span class="op">|</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'fio2'</span>).isNull())))</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>resp_full.select(f.countDistinct(<span class="st">"C19_PATIENT_ID"</span>)).show()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">## Filter out people on NIPPV without a FiO2 measurement--CPAP</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>nippv_test <span class="op">=</span> resp_full.<span class="bu">filter</span>(f.col(<span class="st">'device_name'</span>)<span class="op">==</span><span class="st">"NIPPV"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>nippv_test.summary().show()</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.<span class="bu">filter</span>(<span class="op">~</span>((f.col(<span class="st">'device_name'</span>)<span class="op">==</span><span class="st">'NIPPV'</span>) <span class="op">&amp;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'fio2'</span>).isNull())<span class="op">&amp;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'lpm'</span>).isNull()) <span class="op">&amp;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'peep'</span>).isNull())))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.<span class="bu">filter</span>(<span class="op">~</span>f.col(<span class="st">'mode_name'</span>).rlike(<span class="vs">r'CPAP'</span>))</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>resp_full.select(f.countDistinct(<span class="st">"C19_PATIENT_ID"</span>)).show()</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co">## Replace "NA" strings with actual Nulls</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>resp_full.select(<span class="st">'device_name'</span>).distinct().show()</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">'device_name'</span>, f.when(<span class="op">~</span>f.col(<span class="st">'device_name'</span>).rlike(<span class="vs">r'NA'</span>), f.col(<span class="st">'device_name'</span>)))</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co">## Try to fill in some of the null device names based on other values</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">'device_name_2'</span>, f.expr(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name IS NOT NULL THEN device_name</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name IS NULL AND fio2 ==.21 AND lpm IS NULL AND peep IS NULL AND set_volume IS NULL THEN 'Room Air'</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name IS NULL AND fio2 IS NULL AND lpm ==0 AND peep IS NULL AND set_volume IS NULL THEN 'Room Air'</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name IS NULL AND fio2 IS NULL AND lpm &lt;=20 AND peep IS NULL AND set_volume IS NULL THEN 'Nasal Cannula'</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name IS NULL AND fio2 IS NULL AND lpm &gt;20 AND peep IS NULL AND set_volume IS NULL THEN 'High Flow NC'</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name IS NULL AND fio2 IS NULL AND lpm IS NULL AND set_volume IS NOT NULL THEN 'Vent'</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name == "Nasal Cannula" AND fio2 IS NULL AND lpm &gt;20 THEN 'High Flow NC'</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="co">## Try to fill in FiO2 based on LPM for nasal cannula</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">'fio2_combined'</span>, f.expr(</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN fio2 IS NOT NULL THEN fio2</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN fio2 IS NULL AND device_name_2 == 'Room Air' THEN .21</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN fio2 IS NULL AND device_name_2 == 'Nasal Cannula' THEN ( 0.24 + (0.04 * lpm) )</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="creating-respiratory-support-hourly-blocking" class="level4">
<h4 class="anchored" data-anchor-id="creating-respiratory-support-hourly-blocking">1.2.1 Creating Respiratory Support Hourly Blocking</h4>
<p><strong>Goal</strong>: For each one hour interval, identify highest level of respiratory support and maximum FiO2.</p>
<ol type="1">
<li>Extract the measurement hour and measurement date from the recorded_time</li>
<li>Rank respiratory support devices</li>
<li>Group by C19_HAR_ID, measurement date, and measurement hour, then take the minimum of device_rank (highest level of support) and maximum of fio2</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Extract hour and date for blocking</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'device_name_2'</span>, <span class="st">'recorded_time'</span>, <span class="st">'fio2_combined'</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'recorded_time'</span>)))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>resp_full <span class="op">=</span> resp_full.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'recorded_time'</span>)))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>fio2 <span class="op">=</span> resp_full.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'device_name_2'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'fio2_combined'</span>).distinct()</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Need to rank devices to get max in hour</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>fio2 <span class="op">=</span> fio2.withColumn(<span class="st">"device_rank"</span>, f.expr(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'Vent' THEN 1</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'NIPPV' THEN 2</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'High Flow NC' THEN 3</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'Face Mask' THEN 4 </span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'Trach Collar' THEN 5</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'Nasal Cannula' THEN 6 </span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'Other' THEN 7</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 == 'Room Air' THEN 8</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_name_2 IS NULL THEN NULL</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">## Group by person, device, measurement date and measurement hour; get max FiO2 and LPM within each hour</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>fio2 <span class="op">=</span> fio2.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>            .agg((f.<span class="bu">max</span>(<span class="st">'fio2_combined'</span>).alias(<span class="st">"fio2_combined"</span>)),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                  (f.<span class="bu">min</span>(<span class="st">'device_rank'</span>).alias(<span class="st">"device_rank"</span>))).orderBy(group_cols)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>fio2 <span class="op">=</span> fio2.withColumn(<span class="st">"device_name"</span>, f.expr(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 1 THEN 'Vent'</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 2 THEN 'NIPPV' </span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 3 THEN 'High Flow NC'</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 4 THEN 'Face Mask' </span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 5 THEN 'Trach Collar'</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 6 THEN 'Nasal Cannula'</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 7 THEN 'Other'</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank == 8 THEN 'Room Air'</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_rank IS NULL THEN NULL</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, you have a dataset with one observation per C19_HAR_ID per hour, with the values representing their worst respiratory state in that hour, but only for the hours that have a recorded value. For example, if someone is on a Nasal Cannula with a constant setting for many hours, only the hour that they were started on that device may have an entry. Therefore, we need to carry forward values until another value is recorded, indicating a change in respiratory support, discharge, or death. This will allow us to merge in the minimum PaO2 values per hour using the RCLIF_labs table (see section #) and ensure the PaO2 and FiO2 were measured within the same hour when calculating the PaO2/FiO2 ratio.</p>
<p>To do this, we: 1. Left join back to hourly blocked dataset created in previous code chunk 2. Carry forward values until a change or until discharge</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Merge back to hourly blocked cohort table </span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>fio2_hours <span class="op">=</span> har_ids_hours.join(fio2, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'left'</span>).orderBy(<span class="st">'C19_HAR_ID'</span>, <span class="st">'txnDt'</span>).distinct()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Carry forward device name until another device is recorded or the end of the measurement time window</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>fio2_hours <span class="op">=</span> fio2_hours.withColumn(<span class="st">'device_filled'</span>, </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'device_name'</span>), </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'device_name'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>fio2_hours <span class="op">=</span> fio2_hours.withColumn(<span class="st">'device_filled'</span>, </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                                       f.when(<span class="op">~</span>f.col(<span class="st">'device_filled'</span>).rlike(<span class="vs">r'NULL'</span>), f.col(<span class="st">'device_filled'</span>)))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">## Carry forward FiO2 measurement name until another device is recorded or the end of the measurement time window</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>fio2_hours <span class="op">=</span> fio2_hours.withColumn(<span class="st">"fio2_combined"</span>,fio2_hours.fio2_combined.cast(<span class="st">'double'</span>))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>fio2_hours <span class="op">=</span> fio2_hours.withColumn(<span class="st">'fio2_filled'</span>, </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                                       f.when((f.col(<span class="st">'fio2_combined'</span>).isNotNull()), f.col(<span class="st">'fio2_combined'</span>)))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>fio2_hours <span class="op">=</span> fio2_hours.withColumn(<span class="st">'fio2_filled'</span>, </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'fio2_combined'</span>), </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'fio2_combined'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>, <span class="st">'device_filled'</span>) <span class="op">\</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>fio2_filled <span class="op">=</span> fio2_hours.select(<span class="st">'C19_HAR_ID'</span>,<span class="st">'txnDt'</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'device_filled'</span>,<span class="st">'fio2_filled'</span>).distinct()</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                                  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, we need to bring in PaO2 values using the RCLIF_labs table to calculate PaO2/FiO2 ratio. We will conduct a similar process as above to create an hourly blocked dataset of the minimum PaO2 per hour.</p>
<ol type="1">
<li>Inner join RCLIF_labs to adults hospitalized in time period</li>
<li>Filter to just PaO2 labs</li>
<li>Group by C19_HAR_ID, measurement date, and measurement hour, then take the minimum lab_value</li>
<li>Left join back to hourly blocked dataset</li>
<li>Carry forward values for only 4 hours</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Now need PaO2</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/RCLIF_labs.parquet"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">### Selecting only variables we need</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'lab_result_time'</span>,<span class="st">'lab_name'</span>, <span class="st">'lab_value'</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">### Filtering to only adults in time period</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.join(har_ids, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">### Filtering to only PaO2, formatting values</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.<span class="bu">filter</span>(f.col(<span class="st">"lab_name"</span>)<span class="op">==</span><span class="st">"pao2"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">"lab_value"</span>,labs.lab_value.cast(<span class="st">'double'</span>))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">'lab_result_time'</span>,f.to_timestamp(<span class="st">'lab_result_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Get min PaO2 per hour</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'lab_result_time'</span>)))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'lab_result_time'</span>)))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>pao2 <span class="op">=</span> labs.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'lab_name'</span>, <span class="st">'lab_value'</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>,<span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>pao2 <span class="op">=</span> pao2.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>           .pivot(<span class="st">"lab_name"</span>) <span class="op">\</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>           .agg(f.<span class="bu">min</span>(<span class="st">'lab_value'</span>).alias(<span class="st">"min"</span>)).orderBy(group_cols)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">## Merge back to hourly blocked cohort table </span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>pao2_hours <span class="op">=</span> har_ids_hours.join(pao2, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'left'</span>).orderBy(<span class="st">'C19_HAR_ID'</span>, <span class="st">'txnDt'</span>).distinct()</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">## Carry forward PaO2 until next measurement or end of window, maximum 4 hours</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">### Get time of most recent PaO2</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>pao2_hours <span class="op">=</span> pao2_hours.withColumn(<span class="st">'last_measure'</span>, f.when(f.col(<span class="st">'pao2'</span>).isNotNull(), f.col(<span class="st">'txnDt'</span>)))</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>pao2_hours <span class="op">=</span> pao2_hours.withColumn(<span class="st">'last_measure'</span>, f.coalesce(f.col(<span class="st">'last_measure'</span>), </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>                                                                  f.last(<span class="st">'last_measure'</span>, <span class="va">True</span>)<span class="op">\</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>)<span class="op">\</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                                                                        .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>pao2_hours <span class="op">=</span> pao2_hours.withColumn(<span class="st">'last_measure'</span>,f.to_timestamp(<span class="st">'last_measure'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>pao2_hours <span class="op">=</span> pao2_hours.withColumn(<span class="st">'txnDt'</span>,f.to_timestamp(<span class="st">'txnDt'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co">### Calculate time difference between the hour we're trying to fill and the most recent PaO2, filter to only 3 additional hrs (4 total)</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>pao2_hours <span class="op">=</span> pao2_hours.withColumn(<span class="st">"hour_diff"</span>, </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                                       (f.col(<span class="st">"txnDt"</span>).cast(<span class="st">"long"</span>)<span class="op">-</span>f.col(<span class="st">"last_measure"</span>).cast(<span class="st">"long"</span>))<span class="op">/</span>(<span class="dv">60</span><span class="op">*</span><span class="dv">60</span>))</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>pao2_hours_2 <span class="op">=</span> pao2_hours.<span class="bu">filter</span>((f.col(<span class="st">'hour_diff'</span>)<span class="op">&gt;=</span><span class="dv">0</span>)<span class="op">&amp;</span>(f.col(<span class="st">'hour_diff'</span>)<span class="op">&lt;=</span><span class="dv">3</span>))</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="co">### Fill PaO2 forward</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>pao2_hours_2 <span class="op">=</span> pao2_hours_2.withColumn(<span class="st">'pao2_filled'</span>, f.when(f.col(<span class="st">'pao2'</span>).isNotNull(), f.col(<span class="st">'pao2'</span>)))</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>pao2_hours_2 <span class="op">=</span> pao2_hours_2.withColumn(<span class="st">'pao2_filled'</span>, f.coalesce(f.col(<span class="st">'pao2'</span>), </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>                                                                 f.last(<span class="st">'pao2'</span>, <span class="va">True</span>)<span class="op">\</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>                                                                 .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>, </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>                                                                                          <span class="st">'last_measure'</span>)<span class="op">\</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>                                                                       .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>pao2_filled <span class="op">=</span> pao2_hours_2.select(<span class="st">'C19_HAR_ID'</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'pao2_filled'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, we repeat the process with the RCLIF_vitals table to obtain SpO2 measurements. In the absence of a PaO2/FiO2 ratio, we use SpO2/FiO2 ratio to determine cohort inclusion.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Now need spO2</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/RCLIF_vitals.parquet"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">### Filtering to only adults in time period</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.join(har_ids, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">### Formatting values</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">'measured_time'</span>,f.to_timestamp(<span class="st">'recorded_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">"vital_value"</span>,vitals.vital_value.cast(<span class="st">'double'</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">### Selecting variables we need</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'measured_time'</span>,<span class="st">'vital_name'</span>, <span class="st">'vital_value'</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'measured_time'</span>)))</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'measured_time'</span>)))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">### Filtering to only SpO2, valid values</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>spo2 <span class="op">=</span> vitals.<span class="bu">filter</span>(f.col(<span class="st">"vital_name"</span>)<span class="op">==</span><span class="st">"spO2"</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>spo2 <span class="op">=</span> spo2.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'vital_name'</span>, <span class="st">'vital_value'</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>spo2 <span class="op">=</span> spo2.<span class="bu">filter</span>(f.col(<span class="st">'vital_value'</span>)<span class="op">&gt;</span><span class="dv">60</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>spo2 <span class="op">=</span> spo2.<span class="bu">filter</span>(f.col(<span class="st">'vital_value'</span>)<span class="op">&lt;=</span><span class="dv">100</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Get min SpO2 per hour</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>,<span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>spo2 <span class="op">=</span> spo2.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>           .pivot(<span class="st">"vital_name"</span>) <span class="op">\</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>           .agg(f.<span class="bu">min</span>(<span class="st">'vital_value'</span>).alias(<span class="st">"min"</span>))</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co">## Merge back to hourly blocked cohort table </span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>spo2_hours <span class="op">=</span> har_ids_hours.join(spo2, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'left'</span>).orderBy(<span class="st">'C19_HAR_ID'</span>, <span class="st">'txnDt'</span>).distinct()</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co">## Cary forward SpO2</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>spo2_hours <span class="op">=</span> spo2_hours.withColumn(<span class="st">'spO2_filled'</span>, </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                                           f.when(f.col(<span class="st">'spO2'</span>).isNotNull(), f.col(<span class="st">'spO2'</span>)))</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>spo2_hours <span class="op">=</span> spo2_hours.withColumn(<span class="st">'spO2_filled'</span>, </span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                                           f.coalesce(f.col(<span class="st">'spO2'</span>), </span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                                                      f.last(<span class="st">'spO2'</span>, <span class="va">True</span>)<span class="op">\</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                                                      .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>, <span class="st">'last_measure'</span>)<span class="op">\</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                                                            .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>spO2_filled <span class="op">=</span> spo2_hours.select(<span class="st">'C19_HAR_ID'</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'spO2_filled'</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that we have hourly blocked respiratory support, FiO2, PaO2, and SpO2, we can full join these tables to determine the first hour a patient met the respiratory inclusion criteria (the minimum recorded time of either FiO2/PaO2 &lt; 200, SpO2/FiO2 &lt;179, non-invasive ventilation, or invasive ventilation). I also write this hourly blocked dataset for later use in the 48-hour analytic dataset.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge FiO2, PaO2, spO2 to get FiO2/PaO2</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>,<span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> fio2_filled.join(pao2_filled, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'full'</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.join(spO2_filled, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'full'</span>).orderBy(group_cols)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"fio2_filled"</span>,df.fio2_filled.cast(<span class="st">'double'</span>))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"pao2_filled"</span>,df.pao2_filled.cast(<span class="st">'double'</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"spO2_filled"</span>,df.spO2_filled.cast(<span class="st">'double'</span>))</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get first time on oxygen support &amp; P/F &lt;200</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"p_f"</span>, f.expr(</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN fio2_filled IS NOT NULL AND pao2_filled IS NOT NULL THEN ( pao2_filled / fio2_filled )</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"s_f"</span>, f.expr(</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN fio2_filled IS NOT NULL AND spO2_filled IS NOT NULL THEN ( spO2_filled / fio2_filled )</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.distinct()</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>df.write.parquet(<span class="st">"/project2/wparker/SIPA_data/p_f_combined_filled.parquet"</span>, mode<span class="op">=</span><span class="st">"overwrite"</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co">## Get first time somone on oxygen therapy with PaO2/FiO2 &lt; 200 (S/F &lt; 179 if no P/F measured) and invasive and non-invasive ventilation</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.<span class="bu">filter</span>((((f.col(<span class="st">"p_f"</span>)<span class="op">&lt;</span><span class="dv">200</span>))<span class="op">|</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>                (f.col(<span class="st">"s_f"</span>)<span class="op">&lt;</span><span class="dv">179</span>) <span class="op">|</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                (f.col(<span class="st">'device_filled'</span>)<span class="op">==</span><span class="st">'Vent'</span>) <span class="op">|</span> </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                (f.col(<span class="st">'device_filled'</span>)<span class="op">==</span><span class="st">'NIPPV'</span>)))</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"txnDt"</span>, <span class="st">"device_filled"</span>,<span class="st">"pao2_filled"</span>,<span class="st">"fio2_filled"</span>, <span class="st">"spO2_filled"</span>, <span class="st">"p_f"</span>, <span class="st">"s_f"</span>)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> Window.partitionBy(<span class="st">"C19_HAR_ID"</span>).orderBy(<span class="st">'txnDt'</span>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>df_first_with_time <span class="op">=</span> df.withColumn(<span class="st">"row"</span>,f.row_number().over(w1)) <span class="op">\</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>             .<span class="bu">filter</span>(f.col(<span class="st">"row"</span>) <span class="op">==</span> <span class="dv">1</span>).drop(<span class="st">"row"</span>)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>df_first_with_time <span class="op">=</span> df_first_with_time.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"txnDt"</span>).withColumnRenamed(<span class="st">"txnDt"</span>, <span class="st">"recorded_time"</span>)</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>resp_support <span class="op">=</span> df_first_with_time.groupBy(<span class="st">"C19_HAR_ID"</span>).agg(f.<span class="bu">min</span>(<span class="st">"recorded_time"</span>).alias(<span class="st">"resp_life_support_start"</span>)).distinct()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="determine-if-patients-received-vasopressors" class="level3">
<h3 class="anchored" data-anchor-id="determine-if-patients-received-vasopressors">1.3 Determine if patients received vasopressors</h3>
<p>Using the RCLIF_medication_admin_continuous table, we identify the first instance a patient is started on a vasopressor. We inner join the adults hospitalized in the time period to the RCLIF_medication_admin_continuous table, then filter to only vasopressor medications, then take the first time per patient per encounter to use as the index time.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now pressors</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df_meds <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">'/project2/wparker/SIPA_data/RCLIF_meds_admin_conti.csv'</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_meds <span class="op">=</span> df_meds.withColumn(<span class="st">'admin_time'</span>,f.to_timestamp(<span class="st">'admin_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to pressor medications</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>pressors <span class="op">=</span> df_meds.<span class="bu">filter</span>(f.col(<span class="st">'med_category'</span>)<span class="op">==</span><span class="st">'vasoactives'</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>pressors <span class="op">=</span> pressors.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"admin_time"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get first time someone is on a pressor</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>pressors <span class="op">=</span> pressors.groupBy(<span class="st">"C19_HAR_ID"</span>).agg(f.<span class="bu">min</span>(<span class="st">"admin_time"</span>).alias(<span class="st">"pressor_life_support_start"</span>))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>pressors <span class="op">=</span> pressors.join(har_ids, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'inner'</span>).distinct()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="determine-start-of-life-support" class="level3">
<h3 class="anchored" data-anchor-id="determine-start-of-life-support">1.4 Determine start of life support</h3>
<p>The start of life support will be the index time for constructing the 48 hour analytic dataset (41 hours before, the index hour, and 6 hours after). To do that, we take the minimum between the time respiratory criteria was met and the time vasopressors were started. Now we have a cohort identified with the first hour block life support was initiated (index time).</p>
<p>We also calculate the start of the window time and end of the window time, and “explode” between these times to create the base 48 hour blocked dataset for the cohort that subsequent data will be left joined to.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get first time on life support</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pressors.join(resp_support, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'full'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"life_support_start"</span>, f.least(f.col(<span class="st">'pressor_life_support_start'</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                                                 f.col(<span class="st">'resp_life_support_start'</span>)))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.<span class="bu">filter</span>(f.col(<span class="st">'life_support_start'</span>).isNotNull())</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">'window_start'</span>, (f.col(<span class="st">'life_support_start'</span>)<span class="op">-</span>f.expr(<span class="st">"INTERVAL 41 HOURS"</span>)))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">'window_end'</span>, (f.col(<span class="st">'life_support_start'</span>)<span class="op">+</span>f.expr(<span class="st">"INTERVAL 6 HOURS"</span>)))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"life_support_start"</span>, <span class="st">"window_start"</span>, <span class="st">"window_end"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">## Re-join age at admission and disposition, admission &amp; discharge dttm, and zip</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.join(limited_ids, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.join(demo_disp, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"C19_PATIENT_ID"</span>, <span class="st">"zip_code"</span>, <span class="st">"admission_datetime"</span>, <span class="st">"discharge_datetime"</span>, <span class="st">"life_support_start"</span>, <span class="st">"window_start"</span>, <span class="st">"window_end"</span>, <span class="st">"age_at_admission"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">"disposition"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>df.write.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort.parquet"</span>, mode<span class="op">=</span><span class="st">"overwrite"</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">## Explode between window to get all hourly timestamps</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> df.withColumn(<span class="st">'txnDt'</span>, </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                                   f.explode(f.expr(<span class="st">'sequence(window_start, window_end, interval 1 hour)'</span>)))</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> cohort_hours.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'txnDt'</span>)))</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> cohort_hours.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'txnDt'</span>)))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> cohort_hours.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"C19_PATIENT_ID"</span>, <span class="st">"zip_code"</span>, <span class="st">"admission_datetime"</span>, <span class="st">"discharge_datetime"</span>, <span class="st">"life_support_start"</span>, <span class="st">"window_start"</span>, <span class="st">"window_end"</span>, </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"age_at_admission"</span>, <span class="st">"disposition"</span>, <span class="st">"meas_date"</span>, <span class="st">"meas_hour"</span>).distinct()</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>cohort_hours.write.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort_48.parquet"</span>, mode<span class="op">=</span><span class="st">"overwrite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="constructing-a-48-hour-analytic-dataset" class="level2">
<h2 class="anchored" data-anchor-id="constructing-a-48-hour-analytic-dataset">2. Constructing a 48 Hour Analytic Dataset</h2>
<section id="hour-labs" class="level3">
<h3 class="anchored" data-anchor-id="hour-labs">2.1 48 Hour Labs</h3>
<p>To construct the 48 hour blocked labs dataset, we: 1. Read in RCLIF_labs and cohort identified in previous section 2. Left join RCLIF_labs to cohort 3. Extract the date and hour of each lab, find minimum and maximum per hour per person per encounter</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Read in Labs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/RCLIF_labs.parquet"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">"lab_value"</span>,labs.lab_value.cast(<span class="st">'double'</span>))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">'lab_result_time'</span>,f.to_timestamp(<span class="st">'lab_result_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'lab_result_time'</span>)))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'lab_result_time'</span>)))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'lab_name'</span>, <span class="st">'lab_value'</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Left join to cohort</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort.parquet"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> cohort.withColumn(<span class="st">'life_support_start_time'</span>,f.to_timestamp(<span class="st">'life_support_start'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> cohort.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'life_support_start_time'</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>cohort_labs <span class="op">=</span> cohort.join(labs, on<span class="op">=</span><span class="st">"C19_HAR_ID"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>cohort_labs <span class="op">=</span> cohort_labs.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'life_support_start_time'</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'lab_name'</span>, <span class="st">'lab_value'</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>cohort_labs <span class="op">=</span> cohort_labs.<span class="bu">filter</span>(f.col(<span class="st">'lab_name'</span>).isNotNull())</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>cohort_labs <span class="op">=</span> cohort_labs.<span class="bu">filter</span>(f.col(<span class="st">'lab_value'</span>).isNotNull())</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co">## Get min and max for each time lab</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">"life_support_start_time"</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>cohort_labs_wide <span class="op">=</span> cohort_labs.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                                     .pivot(<span class="st">"lab_name"</span>) <span class="op">\</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                                     .agg(f.<span class="bu">min</span>(<span class="st">'lab_value'</span>).alias(<span class="st">"min"</span>),</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'lab_value'</span>).alias(<span class="st">"max"</span>)).orderBy(group_cols)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, we:</p>
<ol start="4" type="1">
<li>Left join the hourly min and max of all the labs from the previous step to the hourly blocked cohort dataset</li>
<li>Forward fill lab values. For this example, I have only forward filled the three lab values we wanted to use in a 48 hour analytic dataset for SIPA (creatinine, bilirubin, and platelet count). Future work will include making this a function, and filling all min and max lab values.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Join to cohort hourly blocked dataset</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort_48.parquet"</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">'life_support_start'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>cohort_labs_48 <span class="op">=</span> cohort_hours.join(cohort_labs_wide, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">## Carry forward labs we need for SIPA</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>cohort_labs_48 <span class="op">=</span> cohort_labs_48.withColumn(<span class="st">'billirubin_max_filled'</span>, </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'bilirubin_total_max'</span>), </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'bilirubin_total_max'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(group_cols)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>cohort_labs_48 <span class="op">=</span> cohort_labs_48.withColumn(<span class="st">'platelet_count_min_filled'</span>, </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'platelet_count_min'</span>), </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'platelet_count_min'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(group_cols)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>cohort_labs_48 <span class="op">=</span> cohort_labs_48.withColumn(<span class="st">'creatinine_max_filled'</span>, </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'creatinine_max'</span>), </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'creatinine_max'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(group_cols)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>cohort_labs_48.write.parquet(<span class="st">"/project2/wparker/SIPA_data/cohort_labs_48.parquet"</span>, mode<span class="op">=</span><span class="st">"overwrite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lastly, we summarize the values of the additional labs we want for SIPA (BUN, pH, potassium) and save a dataset of one observation per person/encounter with the worst values of all selected labs.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Summarize to one row per person</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">'C19_HAR_ID'</span>, <span class="st">'life_support_start'</span>, <span class="st">'window_start'</span>, <span class="st">'window_end'</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>cohort_labs_48_summary <span class="op">=</span> cohort_labs_48.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                                     .agg(f.<span class="bu">min</span>(<span class="st">'creatinine_max_filled'</span>).alias(<span class="st">"creatinine_max_filled"</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'platelet_count_min_filled'</span>).alias(<span class="st">"platelet_count_min_filled"</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'billirubin_max_filled'</span>).alias(<span class="st">"billirubin_max_filled"</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'potassium_max'</span>).alias(<span class="st">"potassium_max"</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'bun_max'</span>).alias(<span class="st">"bun_max"</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">min</span>(<span class="st">'ph_venous_min'</span>).alias(<span class="st">"ph_venous_min"</span>))<span class="op">\</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                                    .distinct()<span class="op">\</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                                    .orderBy(<span class="st">"life_support_start"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>cohort_labs_48_summary.write.parquet(<span class="st">"/project2/wparker/SIPA_data/cohort_labs_48_summary.parquet"</span>, </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                                       mode<span class="op">=</span><span class="st">"overwrite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="hour-vitals" class="level3">
<h3 class="anchored" data-anchor-id="hour-vitals">2.2 48 Hour Vitals</h3>
<p>We repeat the process to create the 48 hour dataset for vitals. For vitals, we only carry forward height and weight. We also calculate MAP using the hourly SBP and DBP when MAP is not available before summarizing to one obervation per person/encounter to ensure the SBP and DBP are measured within the same hour.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Read in Vitals</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/RCLIF_vitals.parquet"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">'measured_time'</span>,f.to_timestamp(<span class="st">'recorded_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'measured_time'</span>)))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'measured_time'</span>)))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.withColumn(<span class="st">"vital_value"</span>,vitals.vital_value.cast(<span class="st">'double'</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Left join to cohort</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort.parquet"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> cohort.withColumn(<span class="st">'life_support_start'</span>,f.to_timestamp(<span class="st">'life_support_start'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> cohort.withColumn(<span class="st">'window_start'</span>,f.to_timestamp(<span class="st">'window_start'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> cohort.withColumn(<span class="st">'window_end'</span>,f.to_timestamp(<span class="st">'window_end'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>cohort_vitals <span class="op">=</span> cohort.join(vitals, on<span class="op">=</span><span class="st">"C19_HAR_ID"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>cohort_vitals <span class="op">=</span> cohort_vitals.<span class="bu">filter</span>(f.col(<span class="st">'vital_name'</span>).isNotNull())</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>cohort_vitals <span class="op">=</span> cohort_vitals.<span class="bu">filter</span>(f.col(<span class="st">'vital_value'</span>).isNotNull())</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>cohort_vitals <span class="op">=</span> cohort_vitals.<span class="bu">filter</span>(f.col(<span class="st">'vital_value'</span>)<span class="op">&gt;=</span><span class="dv">0</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">## Filter to only vitals in window</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>cohort_vitals_window <span class="op">=</span> cohort_vitals.<span class="bu">filter</span>((f.col(<span class="st">'measured_time'</span>) <span class="op">&gt;=</span> f.col(<span class="st">'window_start'</span>)) <span class="op">&amp;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'measured_time'</span>) <span class="op">&lt;=</span> f.col(<span class="st">'window_end'</span>)))</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>cohort_vitals_wide <span class="op">=</span> cohort_vitals_window.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'life_support_start'</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'vital_name'</span>, <span class="st">'vital_value'</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">## Get min and max for each time vital</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">"life_support_start"</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>cohort_vitals_wide <span class="op">=</span> cohort_vitals_wide.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>                                     .pivot(<span class="st">"vital_name"</span>) <span class="op">\</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>                                     .agg(f.<span class="bu">min</span>(<span class="st">'vital_value'</span>).alias(<span class="st">"min"</span>),</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'vital_value'</span>).alias(<span class="st">"max"</span>)).orderBy(group_cols)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">## Join to cohort hourly blocked dataset</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort_48.parquet"</span>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>, <span class="st">'life_support_start'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48 <span class="op">=</span> cohort_hours.join(cohort_vitals_wide, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="co">## Carry forward height and weight only for SIPA</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48 <span class="op">=</span> cohort_vitals_48.withColumn(<span class="st">'weight_filled'</span>, </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'weight_max'</span>), </span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'weight_max'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48 <span class="op">=</span> cohort_vitals_48.withColumn(<span class="st">'height_filled'</span>, </span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>                                       f.coalesce(f.col(<span class="st">'height_max'</span>), </span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>                                                  f.last(<span class="st">'height_max'</span>, <span class="va">True</span>) <span class="op">\</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>                                                  .over(Window.partitionBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>                                                        .orderBy(<span class="st">'txnDt'</span>)), f.lit(<span class="st">'NULL'</span>)))</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co">## Fill in MAP using SBP and DBP--these need to be measured in same hour, so need to calculate before summarizing </span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48 <span class="op">=</span> cohort_vitals_48.withColumn(<span class="st">"MAP_for_sofa"</span>, f.expr(</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN MAP_min IS NOT NULL THEN MAP_min</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN MAP_min IS NULL AND sbp_min IS NOT NULL AND dbp_min IS NOT NULL THEN ( sbp_min + 2.0 * dbp_min ) / 3.0</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE NULL</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48.write.parquet(<span class="st">"/project2/wparker/SIPA_data/cohort_vitals_48.parquet"</span>, mode<span class="op">=</span><span class="st">"overwrite"</span>)</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a><span class="co">## Summarize to one observation per person/encounter</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">'C19_HAR_ID'</span>, <span class="st">'life_support_start'</span>, <span class="st">'window_start'</span>, <span class="st">'window_end'</span>]</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48_summary <span class="op">=</span> cohort_vitals_48.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>                                     .agg(f.<span class="bu">max</span>(<span class="st">'weight_filled'</span>).alias(<span class="st">"weight_filled"</span>),</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">max</span>(<span class="st">'height_filled'</span>).alias(<span class="st">"height_filled"</span>),</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>                                         f.<span class="bu">min</span>(<span class="st">'MAP_for_sofa'</span>).alias(<span class="st">"MAP_for_sofa"</span>))<span class="op">\</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>                                    .distinct()<span class="op">\</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>                                    .orderBy(<span class="st">"life_support_start"</span>)</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>cohort_vitals_48_summary.write.parquet(<span class="st">"/project2/wparker/SIPA_data/cohort_vitals_48_summary.parquet"</span>, </span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>                                         mode<span class="op">=</span><span class="st">"overwrite"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="combining-respiratory-support-vitals-and-medication-to-determine-hours-of-life-support-received" class="level3">
<h3 class="anchored" data-anchor-id="combining-respiratory-support-vitals-and-medication-to-determine-hours-of-life-support-received">2.3 Combining respiratory support, vitals, and medication to determine hours of life support received</h3>
<p>We start with our base hourly blocked dataset for our cohort. We then left join the hourly blocked respiratory support and hourly blocked vitals created previously. Next, we bring in vasopressor medications and sum the number of vasopressors received per hour and whether it was dobutamine alone.</p>
<p>We capped the number of pressors received at 4, likely because they were being transitioned off some drugs and onto others. Clinically more than 4 would not be used at one time, so we set that as the maximum.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Read in cohort hourly blocked base dataset</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>cohort_hours <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort_48.parquet"</span>).orderBy(group_cols)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">## Bring in respiratory support hourly blocked dataset</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>resp_support <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/p_f_combined_filled.parquet"</span>).orderBy(group_cols)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>resp_support <span class="op">=</span> resp_support.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'device_filled'</span>, <span class="st">'fio2_filled'</span>, <span class="st">'pao2_filled'</span>, <span class="st">'spO2_filled'</span>, <span class="st">'p_f'</span>, <span class="st">'s_f'</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Left join respiratory support to cohort hourly blocked</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>cohort_resp_support <span class="op">=</span> cohort_hours.join(resp_support, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>).orderBy(group_cols)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Bring in worst vitals. Only need MAP for SIPA</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/cohort_vitals_48.parquet"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>vitals <span class="op">=</span> vitals.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'MAP_for_SOFA'</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>cohort_resp_vitals <span class="op">=</span> cohort_resp_support.join(vitals, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>).orderBy(group_cols)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">## bring in meds to get flag for life support yes/no</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Now pressors</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>df_meds <span class="op">=</span> spark.read.parquet(<span class="st">'/project2/wparker/SIPA_data/RCLIF_medication_admin_continuous.parquet'</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>df_meds <span class="op">=</span> df_meds.withColumn(<span class="st">'admin_time'</span>,f.to_timestamp(<span class="st">'admin_dttm'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>df_meds <span class="op">=</span> df_meds.withColumnRenamed(<span class="st">"encounter_id"</span>, <span class="st">"C19_HAR_ID"</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to pressor medications</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>pressors <span class="op">=</span> df_meds.<span class="bu">filter</span>(f.col(<span class="st">'med_category'</span>)<span class="op">==</span><span class="st">'vasoactives'</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>pressors <span class="op">=</span> pressors.select(<span class="st">"C19_HAR_ID"</span>, <span class="st">"admin_time"</span>, <span class="st">"med_name"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">## Get cohort index times</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/life_support_cohort.parquet"</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>cohort <span class="op">=</span> cohort.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'window_start'</span>, <span class="st">'window_end'</span>).distinct()</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co">## Get all pressors in 48 hour window</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>cohort_pressors <span class="op">=</span> cohort.join(pressors,<span class="st">'C19_HAR_ID'</span>,<span class="st">'left'</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>cohort_pressors <span class="op">=</span> cohort_pressors.<span class="bu">filter</span>((f.col(<span class="st">'admin_time'</span>) <span class="op">&gt;=</span> f.col(<span class="st">'window_start'</span>)) <span class="op">&amp;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                              (f.col(<span class="st">'admin_time'</span>) <span class="op">&lt;=</span> f.col(<span class="st">'window_end'</span>)))</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>cohort_pressors_48 <span class="op">=</span> cohort_pressors.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'admin_time'</span>)))</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>cohort_pressors_48 <span class="op">=</span> cohort_pressors_48.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'admin_time'</span>)))</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>cohort_pressors_48 <span class="op">=</span> cohort_pressors_48.select(<span class="st">'C19_HAR_ID'</span>,<span class="st">'meas_hour'</span>,<span class="st">'meas_date'</span>, <span class="st">'med_name'</span>).distinct()</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">## Get number of pressors per hour</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>w2 <span class="op">=</span> Window.partitionBy(group_cols).orderBy(<span class="st">"med_name"</span>)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">'C19_HAR_ID'</span>,<span class="st">'meas_hour'</span>,<span class="st">'meas_date'</span>, <span class="st">'med_name'</span>]</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_48.withColumn(<span class="st">"row"</span>,f.row_number().over(w2))</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_48.withColumn(<span class="st">"count"</span>,f.lit(<span class="dv">1</span>))</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="co">## Get count of pressors per hour</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_grouped.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>                                     .pivot(<span class="st">"med_name"</span>) <span class="op">\</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                                     .agg(f.count(<span class="st">'count'</span>).alias(<span class="st">"count"</span>)).orderBy(group_cols)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_grouped.withColumn(<span class="st">"dobutamine_alone"</span>, f.expr(</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN dobutamine IS NOT NULL AND dopamine IS NULL AND epinephrine IS NULL AND isoproterenol IS NULL AND milrinone IS NULL AND norepinephrine IS NULL AND phenylephrine IS NULL AND vasopressin IS NULL THEN 1</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE 0</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>col_list <span class="op">=</span> [<span class="st">'dobutamine'</span>, <span class="st">'dopamine'</span>, <span class="st">'epinephrine'</span>, <span class="st">'isoproterenol'</span>, <span class="st">'milrinone'</span>, <span class="st">'norepinephrine'</span>, <span class="st">'phenylephrine'</span>, <span class="st">'vasopressin'</span>]</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_grouped.na.fill(<span class="dv">0</span>, subset<span class="op">=</span>col_list)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_grouped.withColumn(<span class="st">'num_pressors'</span>, <span class="bu">sum</span>([f.col(c) <span class="cf">for</span> c <span class="kw">in</span> col_list]))</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_grouped.withColumn(<span class="st">"num_pressors"</span>, f.expr(</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN num_pressors &gt; 4 THEN 4</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE num_pressors</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>cohort_pressors_grouped <span class="op">=</span> cohort_pressors_grouped.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'num_pressors'</span>, <span class="st">'dobutamine_alone'</span>)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">'C19_HAR_ID'</span>,<span class="st">'meas_date'</span>,<span class="st">'meas_hour'</span>]</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>cohort_resp_vitals_pressors <span class="op">=</span> cohort_resp_vitals.join(cohort_pressors_grouped, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>col_list <span class="op">=</span> [<span class="st">'num_pressors'</span>, <span class="st">'dobutamine_alone'</span>]</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>cohort_resp_vitals_pressors <span class="op">=</span> cohort_resp_vitals_pressors.na.fill(<span class="dv">0</span>, subset<span class="op">=</span>col_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, we want to exclude people who received fewer than 6 hours of life support. So we create a flag for if someone received life support in that hour, defined as receiving vasopressor medications, non-invasive or invasive mechanical ventilation, a PaO2/FiO2 ratio less than 200, or an SpO2/FiO2 ratio less than 179. We sum and filter out those receiveing less than 6 hours of life support.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">##Flag if on life support at each hour</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>cohort_resp_vitals_pressors <span class="op">=</span> cohort_resp_vitals_pressors.withColumn(<span class="st">"on_life_support"</span>, f.expr(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"""</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">        CASE</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN num_pressors &gt;=1 THEN 1</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_filled == 'NIPPV' THEN 1</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN device_filled == 'Vent' THEN 1</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN  p_f &lt; 200 THEN 1</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="st">        WHEN s_f &lt; 179 THEN 1</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="st">        ELSE 0</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="st">        END</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>cohort_life_support_count <span class="op">=</span> cohort_resp_vitals_pressors.groupBy(<span class="st">'C19_HAR_ID'</span>) <span class="op">\</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                                            .agg(f.<span class="bu">sum</span>(<span class="st">'on_life_support'</span>).alias(<span class="st">'life_support_count'</span>)) <span class="op">\</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                                            .<span class="bu">filter</span>(f.col(<span class="st">'life_support_count'</span>)<span class="op">&gt;=</span><span class="dv">6</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> cohort_life_support_count.join(cohort_resp_vitals_pressors, on<span class="op">=</span><span class="st">'C19_HAR_ID'</span>, how<span class="op">=</span><span class="st">"left"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="merging-scores-labs-and-dialysis-flag" class="level3">
<h3 class="anchored" data-anchor-id="merging-scores-labs-and-dialysis-flag">2.4 Merging scores, labs, and dialysis flag</h3>
<p>Lastly, we repeat a similar procedure to left join hourly blocked minimum scores, labs, and a flag for whether a person was receiving dialysis.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">## add glasgow score</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">'/project2/wparker/SIPA_data/RCLIF_scores_10192023.csv'</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> scores.withColumn(<span class="st">'score_time'</span>,f.to_timestamp(<span class="st">'score_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> scores.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'score_time'</span>)))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> scores.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'score_time'</span>)))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>scores <span class="op">=</span> scores.withColumn(<span class="st">"score_value"</span>,scores.score_value.cast(<span class="st">'double'</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Get min GCS</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>group_cols <span class="op">=</span> [<span class="st">"C19_HAR_ID"</span>,<span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>scores_wide <span class="op">=</span> scores.groupBy(group_cols) <span class="op">\</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                                     .pivot(<span class="st">"score_name"</span>) <span class="op">\</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                                     .agg(f.<span class="bu">min</span>(<span class="st">'score_value'</span>).alias(<span class="st">"min"</span>)).orderBy(group_cols)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>scores_wide <span class="op">=</span> scores_wide.withColumnRenamed(<span class="st">'NUR RA GLASGOW ADULT SCORING'</span>, <span class="st">'min_gcs_score'</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>cohort_scores_48 <span class="op">=</span> cohort_hours.join(scores_wide, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>cohort_scores_48 <span class="op">=</span> cohort_scores_48.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'min_gcs_score'</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.join(cohort_scores_48, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">## Add labs</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> spark.read.parquet(<span class="st">"/project2/wparker/SIPA_data/cohort_labs_48.parquet"</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> labs.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'billirubin_max_filled'</span>, <span class="st">'potassium_max'</span>, <span class="st">'bun_max'</span>, <span class="st">'ph_venous_min'</span>,</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'platelet_count_min_filled'</span>, <span class="st">'creatinine_max_filled'</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.join(labs, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co">## add dialysis flag</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>dialysis <span class="op">=</span> spark.read.option(<span class="st">"header"</span>,<span class="va">True</span>).csv(<span class="st">'/project2/wparker/SIPA_data/RCLIF_dialysis_flag_only.csv'</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>dialysis <span class="op">=</span> dialysis.withColumn(<span class="st">'recorded_time'</span>,f.to_timestamp(<span class="st">'recorded_time'</span>,<span class="st">'yyyy-MM-dd HH:mm:ss'</span>))</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>dialysis <span class="op">=</span> dialysis.withColumn(<span class="st">'meas_hour'</span>, f.hour(f.col(<span class="st">'recorded_time'</span>)))</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>dialysis <span class="op">=</span> dialysis.withColumn(<span class="st">'meas_date'</span>, f.to_date(f.col(<span class="st">'recorded_time'</span>)))</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>dialysis <span class="op">=</span> dialysis.select(<span class="st">'C19_HAR_ID'</span>, <span class="st">'meas_date'</span>, <span class="st">'meas_hour'</span>, <span class="st">'on_dialysis'</span>) <span class="op">\</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                .distinct() <span class="op">\</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                .groupBy(group_cols) <span class="op">\</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                .agg(f.<span class="bu">max</span>(<span class="st">'on_dialysis'</span>).alias(<span class="st">'on_dialysis'</span>))</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.join(dialysis, on<span class="op">=</span>group_cols, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>df.repartition(<span class="dv">1</span>).write.csv(<span class="st">"/project2/wparker/SIPA_data/sipa_df_48.csv"</span>, mode<span class="op">=</span><span class="st">'overwrite'</span>, header<span class="op">=</span><span class="st">"true"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>